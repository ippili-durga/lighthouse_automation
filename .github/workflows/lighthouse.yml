name: Lighthouse CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: browser-actions/setup-chrome@v1

      - name: Install LHCI
        run: npm i -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.numberOfRuns=3 \
            --collect.settings.chromeFlags="--no-sandbox --disable-dev-shm-usage --ignore-certificate-errors" \
            --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List LHCI output
        if: always()
        run: |
          echo "Contents of .lighthouseci:"
          ls -la .lighthouseci || true

      # === HTML generation from LHCI JSON ===
      - name: Generate HTML reports
        if: always()
        run: |
          npm i lighthouse@11 --no-save
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const { ReportGenerator } = require('lighthouse/report/generator/report-generator.js');
          const dir = '.lighthouseci';
          if (!fs.existsSync(dir)) { console.log('No .lighthouseci directory'); process.exit(0); }
          const jsons = fs.readdirSync(dir).filter(f => f.endsWith('-lhr.json'));
          if (!jsons.length) { console.log('No LHR JSON files found'); process.exit(0); }
          for (const file of jsons) {
            const lhrPath = path.join(dir, file);
            const base = file.replace(/\.json$/, '');
            const htmlPath = path.join(dir, `${base}.html`);
            const lhr = JSON.parse(fs.readFileSync(lhrPath, 'utf8'));
            const html = ReportGenerator.generateReportHtml(lhr);
            fs.writeFileSync(htmlPath, html);
            console.log('Generated', htmlPath);
          }
          NODE

      - name: Upload Lighthouse Reports (JSON + HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/**
          if-no-files-found: warn